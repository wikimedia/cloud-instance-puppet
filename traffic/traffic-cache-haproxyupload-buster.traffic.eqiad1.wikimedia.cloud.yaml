cache::cluster: upload
cache::lua_support: true
cache::nodes:
  upload:
    eqiad:
    - localhost
cache::req_handling:
  default:
    caching: normal
do_acme: false
profile::cache::haproxy::add_headers:
- direction: request
  name: X-Client-IP
  value: '%[src]'
- direction: request
  name: X-Client-Port
  value: '%[src_port]'
- direction: request
  name: X-Forwarded-Proto
  value: https
- direction: request
  name: X-Connection-Properties
  value: '%[lua.xcps]'
- direction: request
  name: X-Analytics-TLS
  value: '%[lua.analytics_tls]'
profile::cache::haproxy::available_unified_certificates:
  digicert-2020:
    cert_paths:
    - /etc/ssl/localcerts/digicert-2020-ecdsa-unified.chained.crt.key
    - /etc/ssl/localcerts/digicert-2020-rsa-unified.chained.crt.key
    server_names:
    - wikipedia.org
    - '*.wikipedia.org'
    - '*.m.wikipedia.org'
    - wikimedia.org
    - '*.wikimedia.org'
    - '*.m.wikimedia.org'
    - '*.planet.wikimedia.org'
    - mediawiki.org
    - '*.mediawiki.org'
    - '*.m.mediawiki.org'
    - wikibooks.org
    - '*.wikibooks.org'
    - '*.m.wikibooks.org'
    - wikidata.org
    - '*.wikidata.org'
    - '*.m.wikidata.org'
    - wikinews.org
    - '*.wikinews.org'
    - '*.m.wikinews.org'
    - wikiquote.org
    - '*.wikiquote.org'
    - '*.m.wikiquote.org'
    - wikisource.org
    - '*.wikisource.org'
    - '*.m.wikisource.org'
    - wikiversity.org
    - '*.wikiversity.org'
    - '*.m.wikiversity.org'
    - wikivoyage.org
    - '*.wikivoyage.org'
    - '*.m.wikivoyage.org'
    - wiktionary.org
    - '*.wiktionary.org'
    - '*.m.wiktionary.org'
    - wikimediafoundation.org
    - '*.wikimediafoundation.org'
    - wmfusercontent.org
    - '*.wmfusercontent.org'
    - w.wiki
  lets-encrypt:
    cert_paths:
    - /etc/acmecerts/unified/live/rsa-2048.chained.crt.key
    - /etc/acmecerts/unified/live/ec-prime256v1.chained.crt.key
    server_names:
    - wikipedia.org
    - '*.wikipedia.org'
    - '*.m.wikipedia.org'
    - wikimedia.org
    - '*.wikimedia.org'
    - '*.m.wikimedia.org'
    - '*.planet.wikimedia.org'
    - mediawiki.org
    - '*.mediawiki.org'
    - '*.m.mediawiki.org'
    - wikibooks.org
    - '*.wikibooks.org'
    - '*.m.wikibooks.org'
    - wikidata.org
    - '*.wikidata.org'
    - '*.m.wikidata.org'
    - wikinews.org
    - '*.wikinews.org'
    - '*.m.wikinews.org'
    - wikiquote.org
    - '*.wikiquote.org'
    - '*.m.wikiquote.org'
    - wikisource.org
    - '*.wikisource.org'
    - '*.m.wikisource.org'
    - wikiversity.org
    - '*.wikiversity.org'
    - '*.m.wikiversity.org'
    - wikivoyage.org
    - '*.wikivoyage.org'
    - '*.m.wikivoyage.org'
    - wiktionary.org
    - '*.wiktionary.org'
    - '*.m.wiktionary.org'
    - wikimediafoundation.org
    - '*.wikimediafoundation.org'
    - wmfusercontent.org
    - '*.wmfusercontent.org'
    - w.wiki
profile::cache::haproxy::del_headers:
- direction: response
  name: X-Analytics
- acl: missing_xwd
  direction: response
  name: Backend-Timing
- acl: missing_xwd
  direction: response
  name: X-ATS-Timestamp
- acl: missing_xwd
  direction: response
  name: X-Envoy-Upstream-Service-Time
- acl: missing_xwd
  direction: response
  name: X-Powered-By
- acl: missing_xwd
  direction: response
  name: X-Request-Id
- acl: missing_xwd
  direction: response
  name: X-Timestamp
- acl: missing_xwd
  direction: response
  name: X-Trans-Id
- acl: missing_xwd
  direction: response
  name: X-Varnish
profile::cache::haproxy::do_ocsp: false
profile::cache::haproxy::extra_certificates:
  wikibase:
    cert_paths:
    - /etc/acmecerts/wikibase/live/rsa-2048.chained.crt.key
    - /etc/acmecerts/wikibase/live/ec-prime256v1.chained.crt.key
    server_names:
    - wikiba-se.traffic.wmflabs.org
profile::cache::haproxy::h2settings:
  header_table_size: 4096
  initial_window_size: 65535
  max_concurrent_streams: 100
profile::cache::haproxy::proxy_protocol: V2
profile::cache::haproxy::timeout:
  client: 300
  client_fin: 120
  connect: 5
  http_request: 3600
  keep_alive: 360
  server: 300
  tunnel: 3600
profile::cache::haproxy::tls13_ciphers: TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
profile::cache::haproxy::tls_cachesize: 20000
profile::cache::haproxy::tls_ciphers: -ALL:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-GCM-SHA256
profile::cache::haproxy::tls_port: 4443
profile::cache::haproxy::tls_session_lifetime: 300
profile::cache::haproxy::unified_acme_chief: true
profile::cache::haproxy::unified_certs:
- digicert-2020-ecdsa-unified
- digicert-2020-rsa-unified
profile::cache::haproxy::varnish_socket: /run/varnish-frontend.socket
profile::cache::haproxy::vars:
- direction: request
  name: txn.xwd_count
  value: req.hdr_cnt(X-Wikimedia-Debug)
profile::cache::varnish::frontend::fe_extra_vcl:
- normalize_path
profile::cache::varnish::frontend::fe_vcl_config:
  allowed_methods: ^(GET|HEAD|OPTIONS|POST|PURGE|PUT|DELETE)$
  enable_geoiplookup: false
  keep: 1d
  large_objects_cutoff: 262144
  maps_domain: maps.beta.wmflabs.org
  purge_host_regex: ^(?!(upload|upload\.wikimedia|maps)\.beta\.wmflabs\.org)
  shortener_domain: w-beta.wmflabs.org
  static_host: en.wikipedia.beta.wmflabs.org
  top_domain: beta.wmflabs.org
  upload_domain: upload.wikimedia.beta.wmflabs.org
  upload_webp_hits_threshold: 1000
  varnish_probe_ms: 100
profile::cache::varnish::frontend::listen_uds: /run/varnish-frontend.socket
profile::cache::varnish::frontend::proxy_on_uds: true
profile::cache::varnish::frontend::uds_owner: envoy
profile::trafficserver::backend::mapping_rules:
- params:
  - '@plugin=/usr/lib/trafficserver/modules/tslua.so'
  - '@pparam=/etc/trafficserver/lua/normalize-path.lua'
  - '@pparam="2F"'
  - '@pparam="21 24 26 27 28 29 2A 2B 2C 3A 3B 3D 40 5B 5D"'
  - '@plugin=/usr/lib/trafficserver/modules/tslua.so'
  - '@pparam=/etc/trafficserver/lua/x-mediawiki-original.lua'
  replacement: http://deployment-ms-fe03.deployment-prep.eqiad.wmflabs
  target: http://upload.beta.wmflabs.org
  type: map
public_tls_unified_cert_vendor: lets-encrypt
